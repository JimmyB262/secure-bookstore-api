<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

<h:head>
    <title>Stock Info</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</h:head>

<h:body>
    <nav class="navbar navbar-expand-lg" style="background-color: #0d6efd;">
        <div class="container-fluid justify-content-between">
            <div class="collapse navbar-collapse d-flex justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item mx-2">
                        <h:link outcome="books.xhtml" styleClass="nav-link text-white">Books</h:link>
                    </li>
                    <li class="nav-item mx-2">
                        <h:link outcome="authors.xhtml" styleClass="nav-link text-white">Authors</h:link>
                    </li>
                </ul>
            </div>

            <!-- Logout icon on the right -->
            <h:form styleClass="d-flex align-items-center ms-3">
                <h:commandLink action="#{userSessionBean.logout}" styleClass="nav-link text-white" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </h:commandLink>
            </h:form>
        </div>
    </nav>
    <div class="container mt-5">
        <div class="card p-4 mb-4">
            <h5>üì¶ All Stock</h5>
            <h:dataTable value="#{stockBean.stockList}" var="s" styleClass="table table-bordered mt-3">
                <h:column>
                    <f:facet name="header">Book</f:facet>
                    <h:link outcome="bookDetails">
                        <f:param name="id" value="#{s.id}" />
                        #{stockBean.getBookTitleById(s.id)}
                    </h:link>
                </h:column>
                <h:column>
                    <f:facet name="header">Quantity</f:facet>
                    #{s.quantity}
                </h:column>
                <h:column rendered="#{userSessionBean.admin}">
                    <f:facet name="header">Edit</f:facet>
                    <h:link outcome="editStockPage">
                        <f:param name="id" value="#{s.id}" />
                        <i class="fas fa-pen" style="color: blue;"></i>
                    </h:link>
                </h:column>
                <h:column rendered="#{userSessionBean.admin}">
                    <f:facet name="header">Delete</f:facet>
                    <h:form>
                        <h:commandButton value="X" style="color: red;"
                                         styleClass="btn btn-link p-0"
                                         action="#{stockBean.deleteStock(s.id)}"
                                         onclick="return confirm('Are you sure you want to delete this stock?');" />
                    </h:form>
                </h:column>
            </h:dataTable>
        </div>

        <div class="card p-4 mb-4">
            <h5>üîç Search Book by ID</h5>
            <h:form styleClass="d-flex gap-2 align-items-center">
                <h:inputText value="#{stockBean.bookIdToSearch}" styleClass="form-control w-25" />
                <h:commandButton styleClass="btn btn-primary" value="Search" action="#{stockBean.searchByBookId}" />
            </h:form>
            <h:panelGroup rendered="#{not empty stockBean.stockById}" class="mt-3">
                <p>Book ID: #{stockBean.stockById.id}</p>
                <p>Quantity: #{stockBean.stockById.quantity}</p>
            </h:panelGroup>
        </div>

        <div class="card p-4 mb-4">
            <h5>üë§ Total Books by Author</h5>
            <h:form styleClass="d-flex gap-2 align-items-center">
                <h:inputText value="#{stockBean.authorIdToSearch}" styleClass="form-control w-25" />
                <h:commandButton styleClass="btn btn-primary" value="Get Total" action="#{stockBean.searchAuthorBookSum}" />
            </h:form>
            <h:panelGroup rendered="#{not empty stockBean.authorBookSum}" class="mt-3">
                <p>Total books by author: #{stockBean.authorBookSum}</p>
            </h:panelGroup>
        </div>

        <div class="card p-4 mb-4">
            <h5>üìà Book(s) with Max Stock</h5>
            <ui:repeat value="#{stockBean.maxStock}" var="m">
                <p>Book ID: #{m.id}, Quantity: #{m.quantity}</p>
            </ui:repeat>

            <hr />
            <h5>üìâ Book(s) with Min Stock</h5>
            <ui:repeat value="#{stockBean.minStock}" var="n">
                <p>Book ID: #{n.id}, Quantity: #{n.quantity}</p>
            </ui:repeat>
        </div>

        <div class="card p-4 mb-4">
            <h5>üìä Average Stock</h5>
            <p>Average stock of all books: #{stockBean.avgStock}</p>
        </div>

        <div class="card p-4 mb-4">
            <h5>üìã Sorted Stock by Quantity</h5>
            <h:dataTable value="#{stockBean.sortedStock}" var="ss" styleClass="table table-bordered mt-3">
                <h:column>
                    <f:facet name="header">Book</f:facet>
                    <h:link outcome="bookDetails">
                        <f:param name="id" value="#{ss.id}" />
                        #{stockBean.getBookTitleById(ss.id)}
                    </h:link>
                </h:column>
                <h:column>
                    <f:facet name="header">Quantity</f:facet>
                    #{ss.quantity}
                </h:column>
            </h:dataTable>
        </div>

        <!-- Admin-only Panels -->
        <h:panelGroup rendered="#{userSessionBean.admin}">
            <div class="card p-4 mb-4">
                <h5>Add New Stock</h5>
                <h:form>
                    <h:panelGrid columns="2" cellpadding="5" styleClass="table table-borderless">

                        <h:outputLabel for="book" value="Select Book:" />
                        <h:selectOneMenu id="book" value="#{stockBean.newStock.id}">
                            <f:selectItem itemLabel="-- Select Book --" itemValue="#{null}" />
                            <f:selectItems value="#{stockBean.books}"
                                           var="book"
                                           itemValue="#{book.id}"
                                           itemLabel="#{book.title} by #{book.author_id.full_name}" />
                        </h:selectOneMenu>

                        <h:outputLabel for="quantity" value="Quantity:" />
                        <h:inputText id="quantity" value="#{stockBean.newStock.quantity}" pt:type="number" pt:min="0" pt:max="150"/>


                    </h:panelGrid>

                    <h:commandButton styleClass="btn btn-primary" value="Add Stock" action="#{stockBean.addStock}" />
                </h:form>
            </div>

            <ui:remove>
                <div class="card p-4 mb-4">
                    <h3>Delete Stock</h3>
                    <h:form>
                        <h:panelGrid columns="2" cellpadding="5" styleClass="table table-borderless">
                            <h:outputLabel for="id" value="Stock Id:" />
                            <h:inputText id="id" value="#{stockBean.newStock.id}" />
                        </h:panelGrid>
                        <h:commandButton styleClass="btn btn-primary" value="Delete Stock" action="#{stockBean.deleteStock}" />
                    </h:form>
                </div>

                <div class="card p-4 mb-4">
                    <h5>Update Stock</h5>
                    <h:form>
                        <h:panelGrid columns="2" cellpadding="5" styleClass="table table-borderless">
                            <h:outputLabel for="id" value="Stock Id:" />
                            <h:inputText id="id" value="#{stockBean.newStock.id}" />

                            <h:outputLabel for="quantity" value="Quantity:" />
                            <h:inputText id="quantity" value="#{stockBean.newStock.quantity}" />
                        </h:panelGrid>
                        <h:commandButton styleClass="btn btn-primary" value="Update Stock" action="#{stockBean.updateStock}" />
                    </h:form>
                </div>
            </ui:remove>
        </h:panelGroup>
    </div>
</h:body>
</html>


